<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#667eea">
    <link rel="manifest" href="manifest.json">
    <title>Gold Rate Checker with Push Notifications</title>
    <link rel="stylesheet" href="styling.css">
</head>
<body>
    <div class="container">
        <h1>üí∞ Gold Rate Checker</h1>
        <p class="subtitle">Professional grade with Push Notifications</p>
        
        <div class="input-group">
            <label for="city">Select City</label>
            <select id="city">
                <option value="">Choose a city...</option>
                <option value="Mumbai">Mumbai</option>
                <option value="Delhi">Delhi</option>
                <option value="Bangalore">Bangalore</option>
                <option value="Hyderabad">Hyderabad</option>
                <option value="Chennai">Chennai</option>
                <option value="Kolkata">Kolkata</option>
                <option value="Pune">Pune</option>
                <option value="Ahmedabad">Ahmedabad</option>
            </select>
        </div>
        
        <div class="input-group">
            <label for="purity">Gold Purity</label>
            <select id="purity">
                <option value="24">24 Karat (99.9% pure)</option>
                <option value="22" selected>22 Karat (91.6% pure)</option>
                <option value="18">18 Karat (75% pure)</option>
            </select>
        </div>
        
        <button onclick="fetchGoldRate()">Get Gold Rate</button>
        
        <div class="loading" id="loading">
            <p>‚è≥ Fetching gold rates...</p>
        </div>
        
        <div class="result" id="result">
            <div class="gold-price" id="goldPrice">‚Çπ0</div>
            <div class="price-detail">
                <span>City:</span>
                <strong id="cityName">-</strong>
            </div>
            <div class="price-detail">
                <span>Purity:</span>
                <strong id="purityLevel">-</strong>
            </div>
            <div class="price-detail">
                <span>Price per 10 grams:</span>
                <strong id="price10g">-</strong>
            </div>
            <div class="price-detail">
                <span>Last Updated:</span>
                <strong id="updateTime">-</strong>
            </div>
        </div>
        
        <div class="notification-section">
            <h3>üîî Push Notifications Setup</h3>
            <div class="status-badge" id="swStatus">
                Service Worker: Checking...
            </div>
            <div class="status-badge" id="notificationStatus">
                Notifications: Checking...
            </div>
            
            <button onclick="enablePushNotifications()">Enable Push Notifications</button>
            <button class="secondary" onclick="testNotification()">Send Test Notification</button>
            
            <div class="input-group" style="margin-top: 20px;">
                <label for="alarmTime">Daily Alert Time</label>
                <input type="time" id="alarmTime" value="09:00">
            </div>
            
            <button onclick="setDailyAlarm()">Set Daily Alarm</button>
            
            <div class="alarm-list" id="alarmList"></div>
        </div>
    </div>
    <script>
        let swRegistration = null;
        let alarms = [];
        
        // Initialize on page load
        window.addEventListener('load', async () => {
            await registerServiceWorker();
            updateNotificationStatus();
            loadAlarms();
            startAlarmChecker();
        });
        
        async function registerServiceWorker() {
            const swStatus = document.getElementById('swStatus');
            
            if (!('serviceWorker' in navigator)) {
                swStatus.textContent = '‚ùå Service Worker: Not supported';
                swStatus.className = 'status-badge error';
                return;
            }
            
            try {
                swRegistration = await navigator.serviceWorker.register('service-worker.js');
                swStatus.textContent = '‚úÖ Service Worker: Registered';
                swStatus.className = 'status-badge success';
                console.log('Service Worker registered:', swRegistration);
            } catch (error) {
                swStatus.textContent = '‚ö†Ô∏è Service Worker: Failed (Need HTTPS hosting)';
                swStatus.className = 'status-badge warning';
                console.log('Service Worker registration failed:', error);
            }
        }
        
        function updateNotificationStatus() {
            const status = document.getElementById('notificationStatus');
            
            if (!('Notification' in window)) {
                status.textContent = '‚ùå Notifications: Not supported';
                status.className = 'status-badge error';
                return;
            }
            
            if (Notification.permission === 'granted') {
                status.textContent = '‚úÖ Notifications: Enabled';
                status.className = 'status-badge success';
            } else if (Notification.permission === 'denied') {
                status.textContent = '‚ùå Notifications: Blocked';
                status.className = 'status-badge error';
            } else {
                status.textContent = '‚ö†Ô∏è Notifications: Not enabled yet';
                status.className = 'status-badge warning';
            }
        }
        
        async function enablePushNotifications() {
            if (!('Notification' in window)) {
                alert('This browser does not support notifications');
                return;
            }
            
            try {
                const permission = await Notification.requestPermission();
                updateNotificationStatus();
                
                if (permission === 'granted') {
                    if (swRegistration) {
                        // In production, you'd subscribe to push service here
                        console.log('Push notifications enabled!');
                        testNotification();
                    } else {
                        alert('‚úÖ Notifications enabled!\n\n‚ö†Ô∏è For full push notification support, please host this app on HTTPS (GitHub Pages or Netlify)');
                    }
                }
            } catch (error) {
                console.error('Error enabling notifications:', error);
                alert('Failed to enable notifications');
            }
        }
        
        function testNotification() {
            if (Notification.permission !== 'granted') {
                alert('Please enable notifications first');
                return;
            }
            
            if (swRegistration && swRegistration.showNotification) {
                swRegistration.showNotification('Test Notification üéâ', {
                    body: 'Your gold rate notifications are working perfectly!',
                    icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y="80" font-size="80">üí∞</text></svg>',
                    vibrate: [200, 100, 200],
                    tag: 'test'
                });
            } else {
                new Notification('Test Notification üéâ', {
                    body: 'Your gold rate notifications are working!',
                    icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y="80" font-size="80">üí∞</text></svg>'
                });
            }
        }
        
        function setDailyAlarm() {
            const city = document.getElementById('city').value;
            const time = document.getElementById('alarmTime').value;
            
            if (!city) {
                alert('Please select a city first');
                return;
            }
            
            const alarm = {
                id: Date.now(),
                city: city,
                time: time,
                active: true
            };
            
            alarms.push(alarm);
            displayAlarms();
            
            if (Notification.permission === 'granted') {
                if (swRegistration) {
                    swRegistration.showNotification('Alarm Set! ‚è∞', {
                        body: `Daily gold rate check set for ${time} in ${city}`,
                        tag: 'alarm-set'
                    });
                } else {
                    new Notification('Alarm Set! ‚è∞', {
                        body: `Daily gold rate check set for ${time} in ${city}`
                    });
                }
            }
        }
        
        function displayAlarms() {
            const list = document.getElementById('alarmList');
            if (alarms.length === 0) {
                list.innerHTML = '';
                return;
            }
            
            list.innerHTML = alarms.map(alarm => `
                <div class="alarm-item">
                    <div>
                        <strong>${alarm.city}</strong> at ${alarm.time} ${alarm.active ? '‚úÖ' : '‚è∏Ô∏è'}
                    </div>
                    <button onclick="removeAlarm(${alarm.id})">Remove</button>
                </div>
            `).join('');
        }
        
        function removeAlarm(id) {
            alarms = alarms.filter(a => a.id !== id);
            displayAlarms();
        }
        
        function loadAlarms() {
            displayAlarms();
        }
        
        function startAlarmChecker() {
            setInterval(() => {
                const now = new Date();
                const currentTime = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
                
                alarms.forEach(alarm => {
                    if (alarm.active && alarm.time === currentTime) {
                        triggerAlarm(alarm);
                    }
                });
            }, 60000);
        }
        
        async function triggerAlarm(alarm) {
            document.getElementById('city').value = alarm.city;
            const rateData = await fetchGoldRate(true);
            
            if (rateData && Notification.permission === 'granted') {
                const message = `Current rate: ‚Çπ${rateData.pricePerGram.toFixed(2)}/gram (${rateData.purity} Karat)`;
                
                if (swRegistration) {
                    swRegistration.showNotification(`Gold Rate - ${alarm.city} üí∞`, {
                        body: message,
                        tag: 'gold-rate-alarm'
                    });
                } else {
                    new Notification(`Gold Rate - ${alarm.city} üí∞`, {
                        body: message
                    });
                }
            }
        }
        
        async function fetchGoldRate(isAlarm = false) {
            const city = document.getElementById('city').value;
            const purity = document.getElementById('purity').value;
            
            if (!city) {
                if (!isAlarm) alert('Please select a city');
                return null;
            }
            
            const loading = document.getElementById('loading');
            const result = document.getElementById('result');
            
            if (!isAlarm) {
                result.classList.remove('show');
                loading.classList.add('show');
            }
            
            // ===== ADD YOUR API KEY HERE =====
            const API_KEY = 'goldapi-g0pj841kmj9ha8r0-io';  // üëà Replace with your actual API key
            // =================================
            
            try {
                // Fetch gold rate from GoldAPI.io
                const response = await fetch('https://www.goldapi.io/api/XAU/INR', {
                    method: 'GET',
                    headers: {
                        'x-access-token': API_KEY,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Failed to fetch gold rates');
                }
                
                const data = await response.json();
                
                // Calculate price based on purity
                const pricePerGram24k = data.price_gram_24k;
                const purityMultiplier = purity === '24' ? 1 : (purity === '22' ? 0.916 : 0.75);
                const finalPricePerGram = pricePerGram24k * purityMultiplier;
                const price10g = finalPricePerGram * 10;
                
                const rateData = {
                    pricePerGram: finalPricePerGram,
                    city: city,
                    purity: purity
                };
                
                if (!isAlarm) {
                    document.getElementById('goldPrice').textContent = 
                        `‚Çπ${finalPricePerGram.toFixed(2)}/gram`;
                    document.getElementById('cityName').textContent = city;
                    document.getElementById('purityLevel').textContent = purity + ' Karat';
                    document.getElementById('price10g').textContent = 
                        `‚Çπ${price10g.toFixed(2)}`;
                    document.getElementById('updateTime').textContent = 
                        new Date(data.timestamp * 1000).toLocaleString();
                    result.classList.add('show');
                }
                
                loading.classList.remove('show');
                return rateData;
                
            } catch (error) {
                loading.classList.remove('show');
                console.error('Error fetching gold rates:', error);
                
                if (!isAlarm) {
                    alert('‚ùå Failed to fetch gold rates. Please check your API key and internet connection.');
                }
                
                return null;
            }
        }
    </script>
</body>
</html>